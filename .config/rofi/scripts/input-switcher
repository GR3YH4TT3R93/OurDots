#!/bin/bash

# Enhanced rofi microphone switcher with icons
# Requires: pulseaudio-utils, rofi

get_audio_sources() {
    pactl list short sources | while read -r line; do
        source_id=$(echo "$line" | awk '{print $1}')
        source_name=$(echo "$line" | awk '{print $2}')
        source_description=$(pactl list sources | grep -A 10 "Source #$source_id" | grep "Description:" | cut -d: -f2- | sed 's/^[ \t]*//')
        source_state=$(pactl list sources | grep -A 10 "Source #$source_id" | grep "State:" | awk '{print $2}')

        # Skip monitor devices and only show actual input sources
        if [[ "$source_name" =~ \.monitor$ ]] || [[ "$source_description" =~ [Mm]onitor ]]; then
            continue
        fi

        # Skip easyeffects virtual source
        if [[ "$source_name" =~ easyeffects ]] || [[ "$source_description" =~ [Ee]asy[Ee]ffects ]]; then
            continue
        fi

        # Determine icon based on source description
        icon=""
        case "$source_description" in
            *"Headset"*|*"headset"*|*"Headphone"*)
                icon=""  # Headphones icon
                ;;
            *"Webcam"*|*"webcam"*|*"Camera"*)
                icon=""  # Camera icon
                ;;
            *"USB"*|*"usb"*)
                icon=""  # USB icon
                ;;
            *"Bluetooth"*|*"bluetooth"*)
                icon=""  # Bluetooth icon
                ;;
            *"Internal"*|*"Built-in"*|*"Laptop"*)
                icon=""  # Microphone icon
                ;;
            *"Mic"*|*"mic"*|*"Microphone"*)
                icon=""  # Microphone icon
                ;;
            *)
                icon=""  # Default microphone icon
                ;;
        esac

        # Show active state
        if pactl get-default-source | grep -q "$source_name"; then
            echo -e "$icon\t$source_description \u2713"
        else
            echo -e "$icon\t$source_description"
        fi
    done
}

set_audio_source() {
    local selected_line="$1"
    # Extract description (remove icon and checkmark)
    selected_description=$(echo "$selected_line" | cut -f2 | sed 's/ \u2713$//')

    pactl list short sources | while read -r line; do
        source_id=$(echo "$line" | awk '{print $1}')
        source_name=$(echo "$line" | awk '{print $2}')
        source_description=$(pactl list sources | grep -A 10 "Source #$source_id" | grep "Description:" | cut -d: -f2- | sed 's/^[ \t]*//')

        if [ "$source_description" = "$selected_description" ]; then
            # Set as default source
            pactl set-default-source "$source_name"

            # Move all recording streams to new source
            pactl list short source-outputs | awk '{print $1}' | while read -r output; do
                pactl move-source-output "$output" "$source_name"
            done

            # Get icon for notification
            icon=$(echo "$selected_line" | cut -f1)
            notify-send -i audio-input-microphone "Microphone" "$icon Switched to: $selected_description"
            break
        fi
    done
}

main() {
    sources_list=$(get_audio_sources)

    if [ -z "$sources_list" ]; then
        notify-send "Microphone" "No input devices found!"
        exit 1
    fi

    selected=$(echo -e "$sources_list" | rofi -dmenu -p "" \
        -no-show-icons \
        -theme-str 'listview {lines: 5;}' )

    if [ -n "$selected" ]; then
        set_audio_source "$selected"
    fi
}

main
